// SPDX-License-Identifier: MIT
pragma solidity ^0.8.28;

import {Test, console} from "forge-std/Test.sol";

/// @notice Gas benchmark for Railgun transact() by replaying a real mainnet tx.
/// TX:    0x105e408f09685adccb1554a325710e90859efcd488fdb2912c8974e73b803cbd
/// Block: 24419683 | Gas used: 1,158,529
contract RailgunTransactBenchmark is Test {
    address constant RELAY_PROXY = 0xFA7093CDD9EE6932B4eb2c9e1cde7CE00B1FA4b9;
    address constant SENDER = 0x0D0Efc24db8fe005e24271c6F823CAC22B0641D8;
    uint256 constant FORK_BLOCK = 24_419_682;
    uint256 constant REAL_GAS = 1_158_529;
    uint256 constant TX_GAS_PRICE = 157_243_696; // wei, from the original tx

    // Calldata from: cast tx 0x105e408f09685adccb1554a325710e90859efcd488fdb2912c8974e73b803cbd input --rpc-url $ETH_RPC_URL
    bytes constant TX_CALLDATA = hex"d8ae136a000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020015725cd8a15be4bf1f7837e7b8c2025d7ca4dbbbdb2f5fa665114e8c6c4c5a11f6fcfa3b23484c94e39f5b9634f30b442537703120465cbea8b4d4da71586b3022de54da17e30e78420c0cc02b0b38dd955562d36e77bbf80b3f7d945f200620937ada831923756d078a862c16c4b8c177952f4e8a588405f1a8b14f8c6f96f1d796199025622d2b6a16ea9d61db03fbe347c51af8e3d7a5fcb7b10fd713f6a1931d5ef9ae87beec74b1f6e68dc41c274f7074954504e7ae61a6b88327fac1e20bf9f3b7488bca5676eff605108792285b958167f49b2507a5183be926d14f721f070faf2042032eaf837092361dab0ec3da2c12979f05ea3991617c1b326e729cee84a6ded1b1a70e3aecc4c98cc7c409e1fe4ae00546139409b08bb8aaede0000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000052ccd390416d0c68a57ebf2b48112f71a8083bdd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000076902dd1000000000000000000000000000000000000000000000000000000000000000011859b778ec78a2eb608f2ec51a3c5fe8e9bab7a5f19a21044966227b2de12c6f00000000000000000000000000000000000000000000000000000000000000032ff10322d6b36b7b4f0062515c568c00f919a7fc6fbce0e958ba05fa44c73e802530747fc11a38e51bf951fc9cb6aa2bfd29bd0a9939192a03e1f996520f4b221ae2ff2f4d3e1dcb52b127193bc2806c7bc7c949936867e121557b1ce6eb7584000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000094797ac000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c04f01dc2f8cd4f194d37dc3e81c4c50ed9856e4661d51a8cca19dc1c5f968b559026c971af7058f3ce0d8e5c780738ef9199bd6985a911380ac07f96f8be3c579c05d076bdfb5bd2d9723d9a75ac98032a0587551f91caa2482fc8578260a83235516c564e7f32556ee2fb8bf74d21412cc637f4e1ea34143f29dbf46207c44c53bd01f88b170da516e2797b923d13f809713d79666de845bb22e7275a39c4966ae3daf0c538abb6d93da3f0198b3fb1b5bf29df2911fc5cb2e53b23b29ac375900000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000003e2ba4d2403f37a3c5a029128945391232dc324c89390f1270688961ab6021b8de6fc2435172ba598d13c2eb2dc867f34073ac5d703ced936103f062479267000000000000000000000000000000000000000000000000000000000000000000008739eda54b121b727f3692b482a471bf9b7e8832b9cc4db9f21e8642afe946b49b911f2d28388f225d222d55b7e124d872e9ce22eca707ae07bb863df524f074d1b06bd6aad30e79899071bcd3353065d3fcd14bbcc42313e24a193e2f7fa70894163ca9bff74ce0f3594f7906d0fd181628ca2ea737d2dde24627087a9eee91bd722e2a55d4d9ddc9dd4925f3d1f1664601fabcd2acb94e62e979e6620c2397bd722e2a55d4d9ddc9dd4925f3d1f1664601fabcd2acb94e62e979e6620c239700000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000003e12c1bddb767444fc8a477364ce058394b991f989ca27c6895fd7d7290af50f92f6bb3d5e8c5dbd4e6fdfd50cff17b554670d548f8faa6dfcae95bb212f6100000000000000000000000000000000000000000000000000000000000000000000";

    function setUp() public {
        vm.createSelectFork(vm.envString("ETH_RPC_URL"), FORK_BLOCK);
    }

    function test_railgun_transact_gas() public {
        assertEq(block.number, FORK_BLOCK, "wrong fork block");

        vm.txGasPrice(TX_GAS_PRICE);
        vm.prank(SENDER);
        uint256 gasBefore = gasleft();
        (bool ok,) = RELAY_PROXY.call(TX_CALLDATA);
        uint256 gasUsed = gasBefore - gasleft();
        assertTrue(ok, "transact() reverted");

        console.log("Railgun transact() gas (measured):", gasUsed);
        console.log("Railgun transact() gas (real tx): ", REAL_GAS);
        console.log("Delta:                            ", _absDiff(gasUsed, REAL_GAS));

        // Fork gas may differ slightly from mainnet; allow 5% tolerance
        assertApproxEqAbs(gasUsed, REAL_GAS, REAL_GAS * 5 / 100, "gas >5% off from real tx");
    }

    function _absDiff(uint256 a, uint256 b) private pure returns (uint256) {
        return a > b ? a - b : b - a;
    }
}
